# Alembic Database Migrations

This directory contains Alembic migration scripts for managing database schema changes in CHAP.

## Overview

CHAP uses a **hybrid migration system**:

1. **Custom Migration System** (`chap_core/database/database.py`):
   - Handles legacy migrations from v1.0.17 and earlier
   - Adds missing columns automatically
   - Will eventually be deprecated

2. **Alembic** (this directory):
   - Manages all new schema changes from the baseline forward
   - Industry-standard migration tool
   - Provides version tracking and rollback support

## Migration Workflow

### For Development

When you need to make a database schema change:

1. **Modify the SQLModel class** (e.g., in `chap_core/database/dataset_tables.py`):
   ```python
   class DataSet(DataSetBase, table=True):
       # Add new column
       new_field: Optional[str] = None
   ```

2. **Generate a migration**:
   ```bash
   uv run alembic revision --autogenerate -m "add_new_field_to_dataset"
   ```

3. **Review the generated migration**:
   - Check `alembic/versions/<revision_id>_add_new_field_to_dataset.py`
   - Ensure the upgrade() and downgrade() functions are correct
   - Make any manual adjustments if needed

4. **Test the migration**:
   ```bash
   # Apply migration
   uv run alembic upgrade head

   # Verify it worked
   uv run alembic current

   # If needed, rollback
   uv run alembic downgrade -1
   ```

5. **Commit the migration**:
   ```bash
   git add alembic/versions/<revision_id>_add_new_field_to_dataset.py
   git commit -m "Add new_field to dataset table"
   ```

### For Production/Deployment

Migrations run **automatically** on `docker compose up`:

1. The API starts and calls `create_db_and_tables()` in `database.py`
2. Custom migrations run first (for backward compatibility)
3. Alembic migrations run next (apply any new schema changes)
4. Tables are created if they don't exist
5. Model templates are seeded

No manual intervention needed!

## Common Commands

```bash
# Show current migration version
uv run alembic current

# Show migration history
uv run alembic history

# Upgrade to latest
uv run alembic upgrade head

# Upgrade by 1 version
uv run alembic upgrade +1

# Downgrade by 1 version
uv run alembic downgrade -1

# Downgrade to specific version
uv run alembic downgrade <revision_id>

# Show pending migrations
uv run alembic heads

# Generate empty migration (for data migrations)
uv run alembic revision -m "description"

# Generate migration with auto-detection
uv run alembic revision --autogenerate -m "description"
```

## Migration Best Practices

1. **Always review autogenerated migrations** - Alembic is smart but not perfect
2. **Test migrations thoroughly** before committing
3. **Write descriptive migration messages** - Use imperative mood (e.g., "add_column" not "added_column")
4. **Don't modify committed migrations** - Create a new migration instead
5. **Include both upgrade() and downgrade()** - Make migrations reversible when possible
6. **Test rollback** - Ensure downgrade() works correctly

## Troubleshooting

### Migration fails with "target database is not up to date"

This means the database has migrations that aren't in your local `alembic/versions/` directory:

```bash
# See what version the database thinks it's at
uv run alembic current

# Pull latest migrations from git
git pull

# Try again
uv run alembic upgrade head
```

### Autogenerate detects changes you didn't make

This usually means:
- Column types differ between model and database
- Nullable/non-nullable mismatch
- Different default values

Review the generated migration carefully and adjust as needed.

### Need to make a data migration (not schema change)

Create an empty migration and add custom logic:

```bash
uv run alembic revision -m "migrate_old_data_format"
```

Edit the generated file:
```python
def upgrade() -> None:
    # Use op.execute() for SQL or connection.execute() for Python
    op.execute("UPDATE table SET new_col = old_col WHERE condition")

def downgrade() -> None:
    # Reverse the data change if possible
    op.execute("UPDATE table SET old_col = new_col WHERE condition")
```

## Migration History

- `fe59a33965ed`: Baseline migration (no-op) - marks the starting point for Alembic
  - All tables managed by custom migration system before this point
  - Future migrations will be added here

## Related Files

- `alembic.ini` - Alembic configuration (database URL, logging, etc.)
- `alembic/env.py` - Migration environment setup (imports SQLModel metadata)
- `chap_core/database/database.py` - Contains custom migration logic and Alembic integration
- `Dockerfile` / `Dockerfile.dev` - Include Alembic files in Docker images

## Learn More

- [Alembic Documentation](https://alembic.sqlalchemy.org/)
- [SQLModel Documentation](https://sqlmodel.tiangolo.com/)
- [Alembic Tutorial](https://alembic.sqlalchemy.org/en/latest/tutorial.html)
